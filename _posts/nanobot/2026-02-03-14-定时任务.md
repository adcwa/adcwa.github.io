# ç¬¬å…­å±‚ï¼šå®šæ—¶ä»»åŠ¡

> ğŸ“Œ **æ ¸å¿ƒæ–‡ä»¶**ï¼š`nanobot/cron/service.py`  
> **é…ç½®æ–‡ä»¶**ï¼š`~/.nanobot/cron.json`

## æ¦‚è¿°

å®šæ—¶ä»»åŠ¡ï¼ˆCronï¼‰å…è®¸ Agent åœ¨æŒ‡å®šæ—¶é—´æˆ–å‘¨æœŸæ€§åœ°æ‰§è¡Œä»»åŠ¡ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ã€‚

## CronJob æ¨¡å‹

```python
class CronJob(BaseModel):
    """å®šæ—¶ä»»åŠ¡æ¨¡å‹"""
    id: str                         # ä»»åŠ¡å”¯ä¸€ ID
    name: str                       # ä»»åŠ¡åç§°
    message: str                    # è¦å‘é€çš„æ¶ˆæ¯
    cron_expr: str | None = None    # Cron è¡¨è¾¾å¼
    interval_seconds: int | None = None  # é—´éš”ç§’æ•°
    enabled: bool = True            # æ˜¯å¦å¯ç”¨
    channel: str | None = None      # ç›®æ ‡æ¸ é“
    to: str | None = None           # æ¥æ”¶è€…
```

## ä¸¤ç§å®šæ—¶æ–¹å¼

### 1. Cron è¡¨è¾¾å¼

```bash
# æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨
# *    *  *  *  *

# ç¤ºä¾‹
"0 9 * * *"      # æ¯å¤© 9:00
"*/30 * * * *"   # æ¯ 30 åˆ†é’Ÿ
"0 */2 * * *"    # æ¯ 2 å°æ—¶
"0 0 * * 1"      # æ¯å‘¨ä¸€ 00:00
"0 12 1 * *"     # æ¯æœˆ 1 å· 12:00
```

### 2. å›ºå®šé—´éš”

```python
interval_seconds=3600    # æ¯å°æ—¶
interval_seconds=86400   # æ¯å¤©
interval_seconds=300     # æ¯ 5 åˆ†é’Ÿ
```

## CronService å®ç°

```python
from croniter import croniter
from datetime import datetime

class CronService:
    """å®šæ—¶ä»»åŠ¡æœåŠ¡"""
    
    def __init__(self, cron_file: Path):
        self.cron_file = cron_file
        self.jobs: list[CronJob] = []
        self.callback: Callable | None = None
        self._running = False
        
        # åŠ è½½ä»»åŠ¡
        self.load_jobs()
    
    def load_jobs(self):
        """ä»æ–‡ä»¶åŠ è½½ä»»åŠ¡"""
        if self.cron_file.exists():
            data = json.loads(self.cron_file.read_text())
            self.jobs = [CronJob(**job) for job in data]
    
    def save_jobs(self):
        """ä¿å­˜ä»»åŠ¡åˆ°æ–‡ä»¶"""
        data = [job.model_dump() for job in self.jobs]
        self.cron_file.write_text(json.dumps(data, indent=2))
    
    def set_callback(self, callback: Callable[[CronJob], Awaitable[None]]):
        """è®¾ç½®ä»»åŠ¡è§¦å‘å›è°ƒ"""
        self.callback = callback
    
    async def start(self):
        """å¯åŠ¨å®šæ—¶ä»»åŠ¡å¾ªç¯"""
        self._running = True
        
        while self._running:
            now = datetime.now()
            
            for job in self.jobs:
                if not job.enabled:
                    continue
                
                if await self._should_run(job, now):
                    if self.callback:
                        await self.callback(job)
                    
                    # æ›´æ–°ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
                    self._update_next_run(job, now)
            
            # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
            await asyncio.sleep(60)
    
    async def _should_run(self, job: CronJob, now: datetime) -> bool:
        """åˆ¤æ–­ä»»åŠ¡æ˜¯å¦åº”è¯¥æ‰§è¡Œ"""
        if job.cron_expr:
            # ä½¿ç”¨ croniter
            cron = croniter(job.cron_expr, now)
            next_run = cron.get_next(datetime)
            
            # å¦‚æœä¸‹æ¬¡æ‰§è¡Œæ—¶é—´åœ¨è¿‡å» 1 åˆ†é’Ÿå†…ï¼Œåˆ™æ‰§è¡Œ
            diff = (next_run - now).total_seconds()
            return -60 < diff <= 0
        
        elif job.interval_seconds:
            # æ£€æŸ¥æ˜¯å¦åˆ°è¾¾é—´éš”æ—¶é—´
            last_run = getattr(job, '_last_run', None)
            if last_run is None:
                return True  # é¦–æ¬¡è¿è¡Œ
            
            elapsed = (now - last_run).total_seconds()
            return elapsed >= job.interval_seconds
        
        return False
    
    def _update_next_run(self, job: CronJob, now: datetime):
        """æ›´æ–°ä»»åŠ¡çš„æœ€åæ‰§è¡Œæ—¶é—´"""
        job._last_run = now
    
    def add_job(self, job: CronJob):
        """æ·»åŠ ä»»åŠ¡"""
        self.jobs.append(job)
        self.save_jobs()
    
    def remove_job(self, job_id: str):
        """åˆ é™¤ä»»åŠ¡"""
        self.jobs = [j for j in self.jobs if j.id != job_id]
        self.save_jobs()
    
    def enable_job(self, job_id: str, enabled: bool = True):
        """å¯ç”¨/ç¦ç”¨ä»»åŠ¡"""
        for job in self.jobs:
            if job.id == job_id:
                job.enabled = enabled
                self.save_jobs()
                break
```

## åœ¨ Gateway ä¸­ä½¿ç”¨

```python
# åˆå§‹åŒ–
cron_service = CronService(workspace / "cron.json")

# è®¾ç½®å›è°ƒï¼šå°†å®šæ—¶æ¶ˆæ¯å‘å¸ƒåˆ°æ¶ˆæ¯æ€»çº¿
async def on_cron_job(job: CronJob):
    await bus.publish_inbound(InboundMessage(
        channel=job.channel or "cli",
        sender_id="cron",
        chat_id=job.to or "system",
        content=job.message,
        session_key=f"cron:{job.id}"
    ))

cron_service.set_callback(on_cron_job)

# å¹¶å‘è¿è¡Œ
await asyncio.gather(
    agent.run(),
    bus.dispatch_outbound(),
    channel_manager.start(),
    cron_service.start(),  # å®šæ—¶ä»»åŠ¡æœåŠ¡
)
```

## CLI å‘½ä»¤

### æ·»åŠ ä»»åŠ¡

```bash
# Cron è¡¨è¾¾å¼
nanobot cron add \
  --name "morning" \
  --message "æ—©ä¸Šå¥½ï¼ä»Šå¤©çš„ä»»åŠ¡..." \
  --cron "0 9 * * *"

# å›ºå®šé—´éš”
nanobot cron add \
  --name "hourly" \
  --message "æ£€æŸ¥ç³»ç»ŸçŠ¶æ€" \
  --every 3600
```

### åˆ—å‡ºä»»åŠ¡

```bash
nanobot cron list
nanobot cron list --all  # åŒ…æ‹¬ç¦ç”¨çš„
```

### åˆ é™¤ä»»åŠ¡

```bash
nanobot cron remove <job_id>
```

### å¯ç”¨/ç¦ç”¨

```bash
nanobot cron enable <job_id>
nanobot cron enable <job_id> --disable
```

### æ‰‹åŠ¨æ‰§è¡Œ

```bash
nanobot cron run <job_id>
```

## ä½¿ç”¨åœºæ™¯

### 1. æ¯æ—¥æé†’

```json
{
  "id": "daily-standup",
  "name": "æ—¥æŠ¥æé†’",
  "message": "å†™ä»Šå¤©çš„æ—¥æŠ¥",
  "cron_expr": "0 18 * * 1-5",  // å·¥ä½œæ—¥ 18:00
  "channel": "telegram",
  "to": "123456"
}
```

### 2. ç³»ç»Ÿç›‘æ§

```json
{
  "id": "health-check",
  "name": "å¥åº·æ£€æŸ¥",
  "message": "æ£€æŸ¥æ‰€æœ‰æœåŠ¡çš„è¿è¡ŒçŠ¶æ€",
  "interval_seconds": 600,  // æ¯ 10 åˆ†é’Ÿ
  "channel": "cli"
}
```

### 3. å®šæœŸæŠ¥å‘Š

```json
{
  "id": "weekly-report",
  "name": "å‘¨æŠ¥",
  "message": "ç”Ÿæˆæœ¬å‘¨çš„å·¥ä½œæ€»ç»“",
  "cron_expr": "0 17 * * 5",  // æ¯å‘¨äº” 17:00
  "channel": "telegram",
  "to": "123456"
}
```

## ä¸å­ä»£ç†çš„ç»“åˆ

å®šæ—¶ä»»åŠ¡å¯ä»¥è§¦å‘å­ä»£ç†ï¼š

```json
{
  "message": "spawn a subagent to check website status every hour"
}
```

Agent ç†è§£åä¼šåˆ›å»ºå­ä»£ç†å¤„ç†ã€‚

## å°ç»“

- âœ… æ”¯æŒ Cron è¡¨è¾¾å¼å’Œå›ºå®šé—´éš”
- âœ… ä»»åŠ¡æŒä¹…åŒ–åˆ° JSON æ–‡ä»¶
- âœ… é€šè¿‡æ¶ˆæ¯æ€»çº¿è§¦å‘ Agent
- âœ… æ”¯æŒå¤šæ¸ é“é€šçŸ¥

**ä¸‹ä¸€æ­¥**ï¼š[15-å¿ƒè·³æœºåˆ¶.md](./nanobot/2026-02-03/15-å¿ƒè·³æœºåˆ¶.md)
