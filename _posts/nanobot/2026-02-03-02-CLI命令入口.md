# ç¬¬ä¸€å±‚ï¼šCLI å‘½ä»¤å…¥å£

> ğŸ“Œ **æ ¸å¿ƒæ–‡ä»¶**ï¼š`nanobot/cli/commands.py` (~656 è¡Œ)

## æ¦‚è¿°

CLIï¼ˆCommand Line Interfaceï¼‰æ˜¯ nanobot çš„ä¸»è¦ç”¨æˆ·æ¥å£ï¼ŒåŸºäº [Typer](https://typer.tiangolo.com/) æ¡†æ¶æ„å»ºã€‚æ‰€æœ‰å‘½ä»¤éƒ½åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰ï¼Œç®€æ´è€Œå¼ºå¤§ã€‚

## Typer æ¡†æ¶ç®€ä»‹

Typer æ˜¯ä¸€ä¸ªç°ä»£çš„ Python CLI æ¡†æ¶ï¼Œç‰¹ç‚¹ï¼š
- è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©æ–‡æ¡£
- ç±»å‹æç¤ºè‡ªåŠ¨éªŒè¯
- å­å‘½ä»¤æ”¯æŒ
- äº¤äº’å¼æç¤º

```python
import typer

app = typer.Typer(
    name="nanobot",
    help="ğŸˆ nanobot - Personal AI Assistant",
    no_args_is_help=True,  # æ— å‚æ•°æ—¶æ˜¾ç¤ºå¸®åŠ©
)

@app.command()
def hello(name: str = typer.Option("World", help="Name to greet")):
    """Say hello"""
    print(f"Hello {name}!")

if __name__ == "__main__":
    app()
```

## æ ¸å¿ƒå‘½ä»¤è¯¦è§£

### 1. `onboard` - åˆå§‹åŒ–

**ç”¨é€”**ï¼šåˆ›å»ºé…ç½®æ–‡ä»¶å’Œå·¥ä½œåŒº

```python
@app.command()
def onboard():
    """Initialize nanobot configuration and workspace."""
    config_dir = Path.home() / ".nanobot"
    config_file = config_dir / "config.json"
    
    # åˆ›å»ºç›®å½•ç»“æ„
    config_dir.mkdir(exist_ok=True)
    (config_dir / "sessions").mkdir(exist_ok=True)
    (config_dir / "memory").mkdir(exist_ok=True)
    (config_dir / "skills").mkdir(exist_ok=True)
    
    # åˆ›å»ºé»˜è®¤é…ç½®
    if not config_file.exists():
        default_config = {
            "providers": {
                "openrouter": {"apiKey": ""}
            },
            "agents": {
                "defaults": {"model": "anthropic/claude-opus-4-5"}
            }
        }
        config_file.write_text(json.dumps(default_config, indent=2))
    
    # åˆ›å»ºå·¥ä½œåŒºæ¨¡æ¿
    _create_workspace_templates(config_dir)
    
    console.print("âœ“ Configuration initialized at ~/.nanobot")
```

**åˆ›å»ºçš„æ–‡ä»¶**ï¼š
```
~/.nanobot/
â”œâ”€â”€ config.json       # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ sessions/         # ä¼šè¯å†å²
â”œâ”€â”€ memory/           # è®°å¿†å­˜å‚¨
â”‚   â””â”€â”€ MEMORY.md
â”œâ”€â”€ skills/           # è‡ªå®šä¹‰æŠ€èƒ½
â”œâ”€â”€ AGENTS.md         # Agent è¡Œä¸ºè§„èŒƒ
â”œâ”€â”€ SOUL.md           # ä¸ªæ€§åŒ–è®¾å®š
â””â”€â”€ USER.md           # ç”¨æˆ·ä¿¡æ¯
```

### 2. `agent` - ä¸ Agent äº¤äº’

**ç”¨é€”**ï¼šç›´æ¥ä¸ Agent å¯¹è¯

```python
@app.command()
def agent(
    message: str = typer.Option(None, "--message", "-m", help="Message to send"),
    session_id: str = typer.Option("cli:default", "--session", "-s", help="Session ID"),
):
    """Interact with the agent directly."""
    
    # åŠ è½½é…ç½®
    config = ConfigLoader().load()
    
    # åˆ›å»º Agent
    provider = create_provider(config)
    agent_loop = AgentLoop(
        bus=MessageBus(),  # CLI æ¨¡å¼ä¸éœ€è¦çœŸæ­£çš„æ¶ˆæ¯æ€»çº¿
        provider=provider,
        workspace=Path.home() / ".nanobot",
        model=config.agents.defaults.model
    )
    
    if message:
        # å•æ¬¡å¯¹è¯æ¨¡å¼
        response = asyncio.run(agent_loop.process_direct(message, session_id))
        console.print(response)
    else:
        # äº¤äº’å¼æ¨¡å¼
        while True:
            user_input = Prompt.ask("[bold blue]You[/bold blue]")
            if user_input.lower() in ["exit", "quit"]:
                break
            
            response = asyncio.run(agent_loop.process_direct(user_input, session_id))
            console.print(f"[bold green]Agent[/bold green]: {response}")
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```bash
# å•æ¬¡å¯¹è¯
nanobot agent -m "ä½ å¥½"
nanobot agent --message "è¯»å– README.md æ–‡ä»¶"

# äº¤äº’å¼å¯¹è¯
nanobot agent
You: ä½ å¥½
Agent: ä½ å¥½ï¼æˆ‘æ˜¯ nanobotï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ
You: é€€å‡º
```

### 3. `gateway` - å¯åŠ¨æ¶ˆæ¯ç½‘å…³

**ç”¨é€”**ï¼šæ”¯æŒå¤šæ¸ é“ï¼ˆTelegram/WhatsAppï¼‰çš„åå°æœåŠ¡

```python
@app.command()
def gateway(
    port: int = typer.Option(18790, "--port", "-p", help="Gateway port"),
    verbose: bool = typer.Option(False, "--verbose", "-v", help="Verbose output"),
):
    """Start the nanobot gateway."""
    
    # è®¾ç½®æ—¥å¿—çº§åˆ«
    if verbose:
        logger.remove()
        logger.add(sys.stderr, level="DEBUG")
    
    # åŠ è½½é…ç½®
    config = ConfigLoader().load()
    workspace = Path.home() / ".nanobot"
    
    # åˆ›å»ºæ ¸å¿ƒç»„ä»¶
    bus = MessageBus()
    provider = create_provider(config)
    
    # Agent Loop
    agent_loop = AgentLoop(
        bus=bus,
        provider=provider,
        workspace=workspace,
        model=config.agents.defaults.model,
        brave_api_key=config.tools.web.search.apiKey if config.tools.web.search else None
    )
    
    # æ¸ é“ç®¡ç†å™¨
    channel_manager = ChannelManager(config, bus)
    
    # Cron æœåŠ¡
    cron_service = CronService(workspace / "cron.json")
    
    # å®šä¹‰ Cron å›è°ƒ
    async def on_cron_job(job: CronJob):
        """æ‰§è¡Œå®šæ—¶ä»»åŠ¡"""
        await bus.publish_inbound(InboundMessage(
            channel=job.channel or "cli",
            sender_id="cron",
            chat_id=job.to or "system",
            content=job.message,
            session_key=f"cron:{job.id}"
        ))
    
    cron_service.set_callback(on_cron_job)
    
    # è¿è¡Œæ‰€æœ‰æœåŠ¡
    async def run():
        await asyncio.gather(
            agent_loop.run(),           # Agent ä¸»å¾ªç¯
            bus.dispatch_outbound(),    # æ¶ˆæ¯åˆ†å‘
            channel_manager.start(),    # æ¸ é“ç›‘å¬
            cron_service.start(),       # å®šæ—¶ä»»åŠ¡
        )
    
    console.print(f"ğŸš€ nanobot gateway started on port {port}")
    asyncio.run(run())
```

**æœåŠ¡æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram Bot   â”‚â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp       â”‚â”€â”€â”¼â”€â”€â”€â†’â”‚ MessageBus   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â–¼
â”‚  Cron Service   â”‚â”€â”€â”˜    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ AgentLoop    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. `cron` - å®šæ—¶ä»»åŠ¡ç®¡ç†

**å­å‘½ä»¤ç»“æ„**ï¼š

```python
cron_app = typer.Typer(help="Manage scheduled tasks")
app.add_typer(cron_app, name="cron")
```

#### 4.1 `cron list` - åˆ—å‡ºä»»åŠ¡

```bash
nanobot cron list
nanobot cron list --all  # åŒ…æ‹¬ç¦ç”¨çš„ä»»åŠ¡
```

#### 4.2 `cron add` - æ·»åŠ ä»»åŠ¡

```python
@cron_app.command("add")
def cron_add(
    name: str = typer.Option(..., "--name", "-n"),
    message: str = typer.Option(..., "--message", "-m"),
    cron: str = typer.Option(None, "--cron"),
    every: int = typer.Option(None, "--every"),
    to: str = typer.Option(None, "--to"),
    channel: str = typer.Option(None, "--channel"),
):
    """Add a scheduled job."""
    
    # éªŒè¯ï¼šå¿…é¡»æŒ‡å®š cron æˆ– every
    if not cron and not every:
        console.print("[red]Error: Must specify either --cron or --every[/red]")
        raise typer.Exit(1)
    
    # åˆ›å»ºä»»åŠ¡
    job = CronJob(
        id=str(uuid.uuid4()),
        name=name,
        message=message,
        cron_expr=cron,
        interval_seconds=every,
        to=to,
        channel=channel,
        enabled=True
    )
    
    service.add_job(job)
    console.print(f"âœ“ Added job {job.id}")
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```bash
# ä½¿ç”¨ cron è¡¨è¾¾å¼ï¼ˆæ¯å¤© 9 ç‚¹ï¼‰
nanobot cron add --name "morning" --message "æ—©ä¸Šå¥½ï¼" --cron "0 9 * * *"

# ä½¿ç”¨é—´éš”ç§’æ•°ï¼ˆæ¯å°æ—¶ï¼‰
nanobot cron add --name "hourly" --message "æ£€æŸ¥çŠ¶æ€" --every 3600

# æŒ‡å®šæ¥æ”¶è€…
nanobot cron add --name "reminder" \
  --message "è®°å¾—å–æ°´" \
  --cron "0 */2 * * *" \
  --channel "telegram" \
  --to "123456789"
```

#### 4.3 `cron remove` - åˆ é™¤ä»»åŠ¡

```bash
nanobot cron remove <job_id>
```

#### 4.4 `cron enable/disable` - å¯ç”¨/ç¦ç”¨

```bash
nanobot cron enable <job_id>
nanobot cron enable <job_id> --disable
```

### 5. `channels` - æ¸ é“ç®¡ç†

#### 5.1 `channels status` - æŸ¥çœ‹çŠ¶æ€

```python
@channels_app.command("status")
def channels_status():
    """Show channel status."""
    config = ConfigLoader().load()
    
    table = Table(title="Channel Status")
    table.add_column("Channel", style="cyan")
    table.add_column("Enabled", style="green")
    table.add_column("Config", style="yellow")
    
    # Telegram
    if config.channels.telegram:
        table.add_row(
            "Telegram",
            "âœ“" if config.channels.telegram.enabled else "âœ—",
            f"Token: {config.channels.telegram.token[:10]}..."
        )
    
    # WhatsApp
    if config.channels.whatsapp:
        table.add_row(
            "WhatsApp",
            "âœ“" if config.channels.whatsapp.enabled else "âœ—",
            f"Allowed: {len(config.channels.whatsapp.allowFrom)} users"
        )
    
    console.print(table)
```

#### 5.2 `channels login` - WhatsApp ç™»å½•

```bash
nanobot channels login
# æ˜¾ç¤ºäºŒç»´ç ï¼Œç”¨ WhatsApp æ‰«æ
```

### 6. `status` - ç³»ç»ŸçŠ¶æ€

```python
@app.command()
def status():
    """Show nanobot status."""
    config_dir = Path.home() / ".nanobot"
    config_file = config_dir / "config.json"
    
    # åŸºæœ¬ä¿¡æ¯
    console.print(f"[bold]nanobot Status[/bold]")
    console.print(f"Version: {__version__}")
    console.print(f"Config: {config_file}")
    console.print(f"Workspace: {config_dir}")
    
    # é…ç½®çŠ¶æ€
    if config_file.exists():
        config = ConfigLoader().load()
        console.print(f"Model: {config.agents.defaults.model}")
        console.print(f"Providers: {', '.join(config.providers.keys())}")
    
    # ä¼šè¯ç»Ÿè®¡
    sessions = list((config_dir / "sessions").glob("*.json"))
    console.print(f"Sessions: {len(sessions)}")
    
    # Cron ä»»åŠ¡
    cron_file = config_dir / "cron.json"
    if cron_file.exists():
        jobs = json.loads(cron_file.read_text())
        console.print(f"Cron jobs: {len(jobs)}")
```

## å‘½ä»¤çš„ç»„ç»‡ç»“æ„

```python
app (ä¸»åº”ç”¨)
â”œâ”€â”€ onboard()          # åˆå§‹åŒ–
â”œâ”€â”€ agent()            # Agent äº¤äº’
â”œâ”€â”€ gateway()          # å¯åŠ¨ç½‘å…³
â”œâ”€â”€ status()           # ç³»ç»ŸçŠ¶æ€
â””â”€â”€ å­åº”ç”¨
    â”œâ”€â”€ cron_app
    â”‚   â”œâ”€â”€ list()
    â”‚   â”œâ”€â”€ add()
    â”‚   â”œâ”€â”€ remove()
    â”‚   â”œâ”€â”€ enable()
    â”‚   â””â”€â”€ run()
    â””â”€â”€ channels_app
        â”œâ”€â”€ status()
        â””â”€â”€ login()
```

## é…ç½®åŠ è½½æµç¨‹

æ¯ä¸ªå‘½ä»¤éƒ½éœ€è¦åŠ è½½é…ç½®ï¼š

```python
from nanobot.config.loader import ConfigLoader

def load_config():
    try:
        config = ConfigLoader().load()
        return config
    except FileNotFoundError:
        console.print("[red]Config not found. Run 'nanobot onboard' first.[/red]")
        raise typer.Exit(1)
    except Exception as e:
        console.print(f"[red]Error loading config: {e}[/red]")
        raise typer.Exit(1)
```

## Rich è¾“å‡ºæ ·å¼

nanobot ä½¿ç”¨ Rich åº“ç¾åŒ–è¾“å‡ºï¼š

```python
from rich.console import Console
from rich.table import Table
from rich.panel import Panel

console = Console()

# è¡¨æ ¼
table = Table(title="Results")
table.add_column("Name", style="cyan")
table.add_column("Value", style="green")
table.add_row("Key", "Value")
console.print(table)

# é¢æ¿
panel = Panel("Important message", title="Info", border_style="blue")
console.print(panel)

# è¿›åº¦æ¡
from rich.progress import track
for i in track(range(100), description="Processing..."):
    # å·¥ä½œ
    pass
```

## é”™è¯¯å¤„ç†

```python
try:
    # æ“ä½œ
    result = do_something()
except ConfigError as e:
    console.print(f"[red]Config error: {e}[/red]")
    raise typer.Exit(1)
except Exception as e:
    logger.exception("Unexpected error")
    console.print(f"[red]Error: {e}[/red]")
    raise typer.Exit(1)
```

## äº¤äº’å¼æç¤º

```python
from rich.prompt import Prompt, Confirm

# æ–‡æœ¬è¾“å…¥
name = Prompt.ask("Enter your name")

# å¸¦é»˜è®¤å€¼
model = Prompt.ask("Model", default="claude-opus-4-5")

# ç¡®è®¤
if Confirm.ask("Continue?"):
    proceed()
```

## å°ç»“

é€šè¿‡æœ¬ç« ï¼Œä½ åº”è¯¥äº†è§£äº†ï¼š
- âœ… Typer æ¡†æ¶çš„åŸºæœ¬ç”¨æ³•
- âœ… nanobot çš„æ‰€æœ‰ CLI å‘½ä»¤
- âœ… å‘½ä»¤çš„å®ç°ç»†èŠ‚
- âœ… é…ç½®åŠ è½½å’Œé”™è¯¯å¤„ç†
- âœ… Rich åº“çš„è¾“å‡ºç¾åŒ–

**ä¸‹ä¸€æ­¥**ï¼š[03-é…ç½®ç³»ç»Ÿ.md](./nanobot/2026-02-03/03-é…ç½®ç³»ç»Ÿ.md) - æ·±å…¥äº†è§£é…ç½®ç®¡ç†ã€‚
