# ç¬¬ä¸‰å±‚ï¼šä¼šè¯ç®¡ç†

> ğŸ“Œ **æ ¸å¿ƒæ–‡ä»¶**ï¼š`nanobot/session/manager.py` (~100 è¡Œ)

## æ¦‚è¿°

ä¼šè¯ç®¡ç†ï¼ˆSession Managementï¼‰è´Ÿè´£æŒä¹…åŒ–å¯¹è¯å†å²ï¼Œè®© Agent èƒ½å¤Ÿè®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚

## ä¼šè¯æ¨¡å‹

```python
from pydantic import BaseModel

class Session(BaseModel):
    """ä¼šè¯æ¨¡å‹"""
    key: str                           # ä¼šè¯æ ‡è¯†ï¼ˆå¦‚ "telegram:123456"ï¼‰
    history: list[dict[str, Any]] = [] # å¯¹è¯å†å²
    
    def add_message(self, role: str, content: str):
        """æ·»åŠ æ¶ˆæ¯åˆ°å†å²"""
        self.history.append({
            "role": role,
            "content": content
        })
    
    def get_history(self) -> list[dict[str, Any]]:
        """è·å–å†å²ï¼ˆä¾› LLM ä½¿ç”¨çš„æ ¼å¼ï¼‰"""
        return self.history
```

## SessionManager

```python
class SessionManager:
    """ä¼šè¯ç®¡ç†å™¨"""
    
    def __init__(self, workspace: Path):
        self.workspace = workspace
        self.sessions_dir = workspace / "sessions"
        self.sessions_dir.mkdir(exist_ok=True)
    
    def get_or_create(self, session_key: str) -> Session:
        """è·å–æˆ–åˆ›å»ºä¼šè¯"""
        session_file = self.sessions_dir / f"{session_key}.json"
        
        if session_file.exists():
            data = json.loads(session_file.read_text())
            return Session(**data)
        
        return Session(key=session_key)
    
    def save(self, session: Session):
        """ä¿å­˜ä¼šè¯"""
        session_file = self.sessions_dir / f"{session.key}.json"
        session_file.write_text(session.model_dump_json(indent=2))
```

## ä½¿ç”¨æ–¹å¼

```python
# åœ¨ AgentLoop ä¸­
session = self.sessions.get_or_create(msg.session_key)

# æ„å»ºæ¶ˆæ¯æ—¶ä½¿ç”¨å†å²
messages = self.context.build_messages(
    history=session.get_history(),
    current_message=msg.content
)

# å¤„ç†å®Œæˆåä¿å­˜
session.add_message("user", msg.content)
session.add_message("assistant", final_content)
self.sessions.save(session)
```

## ä¼šè¯æ–‡ä»¶ç¤ºä¾‹

`~/.nanobot/sessions/telegram:123456789.json`

```json
{
  "key": "telegram:123456789",
  "history": [
    {
      "role": "user",
      "content": "ä½ å¥½"
    },
    {
      "role": "assistant",
      "content": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ"
    },
    {
      "role": "user",
      "content": "è¯»å– config.json æ–‡ä»¶"
    },
    {
      "role": "assistant",
      "content": "æ–‡ä»¶å†…å®¹ï¼š..."
    }
  ]
}
```

## ä¼˜åŒ–å»ºè®®

### 1. é™åˆ¶å†å²é•¿åº¦

```python
def add_message(self, role: str, content: str, max_history: int = 100):
    self.history.append({"role": role, "content": content})
    
    # ä¿ç•™æœ€è¿‘ N æ¡
    if len(self.history) > max_history:
        self.history = self.history[-max_history:]
```

### 2. å®šæœŸæ¸…ç†æ—§ä¼šè¯

```python
def cleanup_old_sessions(self, days: int = 30):
    """åˆ é™¤è¶…è¿‡ N å¤©æœªä½¿ç”¨çš„ä¼šè¯"""
    cutoff = datetime.now() - timedelta(days=days)
    
    for session_file in self.sessions_dir.glob("*.json"):
        if session_file.stat().st_mtime < cutoff.timestamp():
            session_file.unlink()
```

## å°ç»“

- âœ… ç®€å•çš„æœ¬åœ° JSON å­˜å‚¨
- âœ… æ”¯æŒå¤šæ¸ é“ç‹¬ç«‹ä¼šè¯
- âœ… æ˜“äºæ‰©å±•ï¼ˆå¯æ¢æˆæ•°æ®åº“ï¼‰

**ä¸‹ä¸€æ­¥**ï¼š[09-å†…ç½®å·¥å…·è¯¦è§£.md](./nanobot/2026-02-03/09-å†…ç½®å·¥å…·è¯¦è§£.md)
