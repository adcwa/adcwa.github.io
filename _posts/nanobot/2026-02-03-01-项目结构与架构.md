# ç¬¬ä¸€å±‚ï¼šé¡¹ç›®ç»“æ„ä¸æ¶æ„

## ç›®å½•ç»“æ„

nanobot çš„ç›®å½•ç»“æ„éå¸¸æ¸…æ™°ï¼Œåæ˜ äº†å…¶æ¨¡å—åŒ–è®¾è®¡ï¼š

```
nanobot/
â”œâ”€â”€ nanobot/              # æ ¸å¿ƒä»£ç åŒ…
â”‚   â”œâ”€â”€ __init__.py       # åŒ…åˆå§‹åŒ–ï¼Œå¯¼å‡ºç‰ˆæœ¬ä¿¡æ¯
â”‚   â”œâ”€â”€ __main__.py       # ç¨‹åºå…¥å£ç‚¹
â”‚   â”œâ”€â”€ agent/            # ğŸ§  æ ¸å¿ƒæ™ºèƒ½ä½“é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ loop.py       #    Agent ä¸»å¾ªç¯ï¼ˆLLM â†” å·¥å…·æ‰§è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ context.py    #    æç¤ºè¯æ„å»ºå™¨
â”‚   â”‚   â”œâ”€â”€ memory.py     #    æŒä¹…åŒ–è®°å¿†
â”‚   â”‚   â”œâ”€â”€ skills.py     #    æŠ€èƒ½åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ subagent.py   #    åå°å­ä»»åŠ¡æ‰§è¡Œ
â”‚   â”‚   â””â”€â”€ tools/        #    å†…ç½®å·¥å…·é›†
â”‚   â”‚       â”œâ”€â”€ base.py   #      å·¥å…·åŸºç±»
â”‚   â”‚       â”œâ”€â”€ registry.py     # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”‚       â”œâ”€â”€ filesystem.py   # æ–‡ä»¶ç³»ç»Ÿå·¥å…·
â”‚   â”‚       â”œâ”€â”€ shell.py        # Shell å‘½ä»¤æ‰§è¡Œ
â”‚   â”‚       â”œâ”€â”€ web.py          # Web æœç´¢å’ŒæŠ“å–
â”‚   â”‚       â”œâ”€â”€ message.py      # æ¶ˆæ¯å‘é€
â”‚   â”‚       â””â”€â”€ spawn.py        # å­ä»£ç†ç”Ÿæˆ
â”‚   â”œâ”€â”€ skills/           # ğŸ¯ é¢„ç½®æŠ€èƒ½åŒ…ï¼ˆå¯æ‰©å±•ï¼‰
â”‚   â”‚   â”œâ”€â”€ github/       #    GitHub é›†æˆ
â”‚   â”‚   â”œâ”€â”€ weather/      #    å¤©æ°”æŸ¥è¯¢
â”‚   â”‚   â”œâ”€â”€ tmux/         #    Tmux ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ summarize/    #    å†…å®¹æ‘˜è¦
â”‚   â”‚   â””â”€â”€ skill-creator/ #   æŠ€èƒ½åˆ›å»ºåŠ©æ‰‹
â”‚   â”œâ”€â”€ providers/        # ğŸ¤– LLM æä¾›å•†
â”‚   â”‚   â”œâ”€â”€ base.py       #    æä¾›å•†åŸºç±»
â”‚   â”‚   â”œâ”€â”€ litellm_provider.py  # LiteLLM å®ç°
â”‚   â”‚   â””â”€â”€ transcription.py     # è¯­éŸ³è½¬æ–‡å­—
â”‚   â”œâ”€â”€ channels/         # ğŸ“± å¤šæ¸ é“é›†æˆ
â”‚   â”‚   â”œâ”€â”€ base.py       #    æ¸ é“åŸºç±»
â”‚   â”‚   â”œâ”€â”€ manager.py    #    æ¸ é“ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ telegram.py   #    Telegram Bot
â”‚   â”‚   â””â”€â”€ whatsapp.py   #    WhatsApp é›†æˆ
â”‚   â”œâ”€â”€ bus/              # ğŸšŒ æ¶ˆæ¯æ€»çº¿ï¼ˆè§£è€¦é€šä¿¡ï¼‰
â”‚   â”‚   â”œâ”€â”€ queue.py      #    å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”‚   â””â”€â”€ events.py     #    æ¶ˆæ¯äº‹ä»¶å®šä¹‰
â”‚   â”œâ”€â”€ session/          # ğŸ’¬ ä¼šè¯ç®¡ç†
â”‚   â”‚   â””â”€â”€ manager.py    #    ä¼šè¯çŠ¶æ€å­˜å‚¨
â”‚   â”œâ”€â”€ config/           # âš™ï¸  é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ schema.py     #    é…ç½®æ¨¡å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ loader.py     #    é…ç½®åŠ è½½å™¨
â”‚   â”œâ”€â”€ cron/             # â° å®šæ—¶ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ service.py    #    Cron æœåŠ¡
â”‚   â”‚   â””â”€â”€ types.py      #    ä»»åŠ¡ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ heartbeat/        # ğŸ’“ å¿ƒè·³æœºåˆ¶
â”‚   â”‚   â””â”€â”€ service.py    #    ä¸»åŠ¨å”¤é†’æœåŠ¡
â”‚   â”œâ”€â”€ cli/              # ğŸ–¥ï¸  å‘½ä»¤è¡Œæ¥å£
â”‚   â”‚   â””â”€â”€ commands.py   #    æ‰€æœ‰ CLI å‘½ä»¤
â”‚   â””â”€â”€ utils/            # ğŸ”§ å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ helpers.py    #    è¾…åŠ©å‡½æ•°
â”œâ”€â”€ bridge/               # WhatsApp æ¡¥æ¥ï¼ˆNode.jsï¼‰
â”œâ”€â”€ workspace/            # ç¤ºä¾‹å·¥ä½œåŒº
â”œâ”€â”€ pyproject.toml        # é¡¹ç›®é…ç½®å’Œä¾èµ–
â”œâ”€â”€ Dockerfile            # Docker é•œåƒå®šä¹‰
â””â”€â”€ README.md             # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## æ¶æ„è®¾è®¡åŸåˆ™

### 1. æ¨¡å—åŒ–åˆ†å±‚
nanobot é‡‡ç”¨ç»å…¸çš„åˆ†å±‚æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ç”¨æˆ·æ¥å£å±‚ï¼ˆCLI / Channelsï¼‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ¶ˆæ¯æ€»çº¿å±‚ï¼ˆMessage Busï¼‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ™ºèƒ½ä½“æ ¸å¿ƒå±‚ï¼ˆAgent Coreï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    å·¥å…·æ‰§è¡Œå±‚ï¼ˆToolsï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    LLM æä¾›å•†å±‚ï¼ˆProvidersï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è§£è€¦è®¾è®¡
- **æ¶ˆæ¯æ€»çº¿**ï¼šchannel å’Œ agent é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦
- **å·¥å…·æ³¨å†Œè¡¨**ï¼šå·¥å…·é€šè¿‡æ³¨å†Œè¡¨åŠ¨æ€åŠ è½½
- **æŠ€èƒ½ç³»ç»Ÿ**ï¼šæŠ€èƒ½ç‹¬ç«‹äºæ ¸å¿ƒä»£ç ï¼Œå¯çƒ­æ’æ‹”

### 3. å¼‚æ­¥ä¼˜å…ˆ
- æ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
- ä½¿ç”¨ `asyncio` å®ç°å¹¶å‘
- æ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒé«˜ååé‡

## æ ¸å¿ƒæ•°æ®æµ

### å®Œæ•´çš„æ¶ˆæ¯å¤„ç†æµç¨‹ï¼š

```mermaid
graph TD
    A[ç”¨æˆ·è¾“å…¥] -->|é€šè¿‡ Channel| B[InboundMessage]
    B -->|å‘å¸ƒåˆ°| C[MessageBus.inbound]
    C -->|Agent æ¶ˆè´¹| D[AgentLoop._process_message]
    D -->|æ„å»ºä¸Šä¸‹æ–‡| E[ContextBuilder]
    E -->|ç”Ÿæˆ Prompt| F[LLM Provider]
    F -->|è¿”å›å“åº”| G{æœ‰å·¥å…·è°ƒç”¨?}
    G -->|æ˜¯| H[ToolRegistry.execute]
    H -->|ç»“æœåé¦ˆ| F
    G -->|å¦| I[æœ€ç»ˆå“åº”]
    I -->|å‘å¸ƒåˆ°| J[MessageBus.outbound]
    J -->|åˆ†å‘åˆ°| K[Channel]
    K -->|è¿”å›| L[ç”¨æˆ·]
```

### å…³é”®ç»„ä»¶è¯´æ˜ï¼š

1. **InboundMessage**ï¼šå°è£…ç”¨æˆ·è¾“å…¥
   - channelï¼šæ¶ˆæ¯æ¥æºï¼ˆcli/telegram/whatsappï¼‰
   - sender_idï¼šå‘é€è€… ID
   - contentï¼šæ¶ˆæ¯å†…å®¹
   - mediaï¼šå¯é€‰çš„åª’ä½“é™„ä»¶

2. **MessageBus**ï¼šæ¶ˆæ¯è·¯ç”±ä¸­å¿ƒ
   - inbound queueï¼šå¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯
   - outbound queueï¼šå¾…å‘é€çš„å“åº”
   - æ”¯æŒè®¢é˜…-å‘å¸ƒæ¨¡å¼

3. **AgentLoop**ï¼šæ™ºèƒ½ä½“æ ¸å¿ƒ
   - å¤„ç†æ¶ˆæ¯çš„ä¸»å¾ªç¯
   - åè°ƒ LLM è°ƒç”¨å’Œå·¥å…·æ‰§è¡Œ
   - ç®¡ç†å¯¹è¯å†å²å’Œä¼šè¯

4. **ToolRegistry**ï¼šå·¥å…·ç®¡ç†å™¨
   - æ³¨å†Œæ‰€æœ‰å¯ç”¨å·¥å…·
   - ç”Ÿæˆå·¥å…·å®šä¹‰ï¼ˆOpenAI Function Calling æ ¼å¼ï¼‰
   - æ‰§è¡Œå·¥å…·è°ƒç”¨

## å…³é”®æ–‡ä»¶è¯¦è§£

### 1. `nanobot/__main__.py`
ç¨‹åºçš„çœŸæ­£å…¥å£ç‚¹ï¼š
```python
from nanobot.cli.commands import app
if __name__ == "__main__":
    app()
```
éå¸¸ç®€æ´ï¼Œç›´æ¥è°ƒç”¨ CLI åº”ç”¨ã€‚

### 2. `nanobot/agent/loop.py` (~330 è¡Œ)
è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å¤§è„‘ï¼ŒåŒ…å«ï¼š
- `AgentLoop` ç±»ï¼šæ ¸å¿ƒå¤„ç†å¼•æ“
- `run()` æ–¹æ³•ï¼šä¸»äº‹ä»¶å¾ªç¯
- `_process_message()` æ–¹æ³•ï¼šå•æ¡æ¶ˆæ¯å¤„ç†
- å·¥å…·æ³¨å†Œå’Œæ‰§è¡Œé€»è¾‘

### 3. `nanobot/bus/queue.py` (~82 è¡Œ)
æ¶ˆæ¯æ€»çº¿çš„å®ç°ï¼Œæå…¶ç®€æ´ï¼š
- ä¸¤ä¸ª `asyncio.Queue`ï¼šinbound å’Œ outbound
- å‘å¸ƒ-è®¢é˜…æœºåˆ¶
- å¼‚æ­¥æ¶ˆæ¯åˆ†å‘

### 4. `nanobot/cli/commands.py` (~656 è¡Œ)
æ‰€æœ‰ CLI å‘½ä»¤çš„å®ç°ï¼š
- `onboard`ï¼šåˆå§‹åŒ–é…ç½®
- `agent`ï¼šç›´æ¥ä¸ Agent äº¤äº’
- `gateway`ï¼šå¯åŠ¨æ¶ˆæ¯ç½‘å…³
- `cron`ï¼šå®šæ—¶ä»»åŠ¡ç®¡ç†
- ç­‰ç­‰...

## ä»£ç é£æ ¼ç‰¹ç‚¹

### 1. ç®€æ´æ˜äº†
```python
# å…¸å‹çš„ç±»å®šä¹‰ - æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²
class AgentLoop:
    """
    The agent loop is the core processing engine.
    
    It:
    1. Receives messages from the bus
    2. Builds context with history, memory, skills
    3. Calls the LLM
    4. Executes tool calls
    5. Sends responses back
    """
```

### 2. ç±»å‹æç¤º
```python
async def chat(
    self,
    messages: list[dict[str, Any]],
    tools: list[dict[str, Any]] | None = None,
    model: str | None = None,
) -> LLMResponse:
```
ä½¿ç”¨ç°ä»£ Python ç±»å‹æç¤ºï¼ˆPython 3.10+ çš„è”åˆç±»å‹è¯­æ³•ï¼‰ã€‚

### 3. å¼‚æ­¥è®¾è®¡
```python
async def run(self) -> None:
    """Run the agent loop, processing messages from the bus."""
    while self._running:
        msg = await self.bus.consume_inbound()
        response = await self._process_message(msg)
        await self.bus.publish_outbound(response)
```

## ä¾èµ–å…³ç³»å›¾

```
cli/commands.py
    â”œâ”€â”€ config/loader.py
    â”œâ”€â”€ bus/queue.py
    â”œâ”€â”€ agent/loop.py
    â”‚   â”œâ”€â”€ agent/context.py
    â”‚   â”‚   â”œâ”€â”€ agent/memory.py
    â”‚   â”‚   â””â”€â”€ agent/skills.py
    â”‚   â”œâ”€â”€ agent/tools/*.py
    â”‚   â”œâ”€â”€ agent/subagent.py
    â”‚   â””â”€â”€ session/manager.py
    â”œâ”€â”€ providers/litellm_provider.py
    â””â”€â”€ channels/*.py
```

## å¯åŠ¨æµç¨‹åˆ†æ

å½“ä½ è¿è¡Œ `nanobot gateway` æ—¶ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

```python
# 1. CLI å…¥å£ (commands.py)
@app.command()
def gateway(port: int = 18790):
    # 2. åŠ è½½é…ç½®
    config = ConfigLoader().load()
    
    # 3. åˆ›å»ºæ ¸å¿ƒç»„ä»¶
    bus = MessageBus()
    provider = LiteLLMProvider(...)
    agent = AgentLoop(bus, provider, ...)
    
    # 4. å¯åŠ¨æ¸ é“
    channel_manager = ChannelManager(config, bus)
    
    # 5. è¿è¡Œäº‹ä»¶å¾ªç¯
    async def run():
        await asyncio.gather(
            agent.run(),              # Agent ä¸»å¾ªç¯
            bus.dispatch_outbound(),  # æ¶ˆæ¯åˆ†å‘
            channel_manager.start(),  # æ¸ é“ç›‘å¬
        )
    
    asyncio.run(run())
```

## æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 1. è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserverï¼‰
- MessageBus çš„è®¢é˜…-å‘å¸ƒæœºåˆ¶
- Channels è®¢é˜… outbound æ¶ˆæ¯

### 2. ç­–ç•¥æ¨¡å¼ï¼ˆStrategyï¼‰
- ä¸åŒçš„ LLM Provider å®ç°åŒä¸€æ¥å£
- ä¸åŒçš„ Channel å®ç°åŒä¸€æ¥å£

### 3. æ³¨å†Œè¡¨æ¨¡å¼ï¼ˆRegistryï¼‰
- ToolRegistry ç®¡ç†æ‰€æœ‰å·¥å…·
- åŠ¨æ€æ³¨å†Œå’ŒæŸ¥æ‰¾

### 4. æ„å»ºå™¨æ¨¡å¼ï¼ˆBuilderï¼‰
- ContextBuilder ç»„è£…å¤æ‚çš„æç¤ºè¯

## æ‰©å±•ç‚¹

nanobot è®¾è®¡äº†å¤šä¸ªæ‰©å±•ç‚¹ï¼š

| æ‰©å±•ç‚¹ | ä½ç½® | ç”¨é€” |
|--------|------|------|
| **Tool** | `agent/tools/base.py` | æ·»åŠ æ–°çš„å·¥å…·èƒ½åŠ› |
| **Skill** | `skills/*/SKILL.md` | æ·»åŠ æ–°çš„æŠ€èƒ½åŒ… |
| **Provider** | `providers/base.py` | æ·»åŠ æ–°çš„ LLM æä¾›å•† |
| **Channel** | `channels/base.py` | æ·»åŠ æ–°çš„èŠå¤©æ¸ é“ |

## å°ç»“

é€šè¿‡æœ¬ç« ï¼Œä½ åº”è¯¥äº†è§£äº†ï¼š
- âœ… nanobot çš„æ•´ä½“ç›®å½•ç»“æ„
- âœ… æ ¸å¿ƒæ¶æ„å’Œåˆ†å±‚è®¾è®¡
- âœ… æ•°æ®æµå’Œæ¶ˆæ¯å¤„ç†æµç¨‹
- âœ… å…³é”®æ–‡ä»¶çš„ä½œç”¨
- âœ… ä»£ç é£æ ¼å’Œè®¾è®¡æ¨¡å¼

**ä¸‹ä¸€æ­¥**ï¼š[02-CLIå‘½ä»¤å…¥å£.md](./nanobot/2026-02-03/nanobot/02-CLIå‘½ä»¤å…¥å£.md) - æ·±å…¥äº†è§£ç”¨æˆ·å¦‚ä½•ä¸ç³»ç»Ÿäº¤äº’ã€‚
