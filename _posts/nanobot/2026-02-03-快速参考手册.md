# nanobot å¿«é€Ÿå‚è€ƒæ‰‹å†Œ

> ğŸ¯ é€‚åˆå·²ç»äº†è§£åŸºæœ¬æ¦‚å¿µï¼Œéœ€è¦å¿«é€ŸæŸ¥æ‰¾ API å’Œç”¨æ³•çš„å¼€å‘è€…

## ç›®å½•

- [æ ¸å¿ƒç»„ä»¶ API](#æ ¸å¿ƒç»„ä»¶-api)
- [CLI å‘½ä»¤é€ŸæŸ¥](#cli-å‘½ä»¤é€ŸæŸ¥)
- [é…ç½®æ–‡ä»¶æ¨¡æ¿](#é…ç½®æ–‡ä»¶æ¨¡æ¿)
- [å·¥å…·å¼€å‘æ¨¡æ¿](#å·¥å…·å¼€å‘æ¨¡æ¿)
- [æŠ€èƒ½å¼€å‘æ¨¡æ¿](#æŠ€èƒ½å¼€å‘æ¨¡æ¿)
- [å¸¸è§é—®é¢˜é€ŸæŸ¥](#å¸¸è§é—®é¢˜é€ŸæŸ¥)

---

## æ ¸å¿ƒç»„ä»¶ API

### AgentLoop

```python
from nanobot.agent.loop import AgentLoop
from nanobot.bus.queue import MessageBus
from nanobot.providers.litellm_provider import LiteLLMProvider
from pathlib import Path

# åˆå§‹åŒ–
bus = MessageBus()
provider = LiteLLMProvider(api_key="sk-...", default_model="...")
agent = AgentLoop(
    bus=bus,
    provider=provider,
    workspace=Path.home() / ".nanobot",
    model="anthropic/claude-opus-4-5",  # å¯é€‰ï¼Œè¦†ç›–é»˜è®¤æ¨¡å‹
    max_iterations=20,                   # å¯é€‰ï¼Œæœ€å¤§å¾ªç¯æ¬¡æ•°
    brave_api_key="BSA-..."             # å¯é€‰ï¼ŒWeb æœç´¢
)

# è¿è¡Œ Agent å¾ªç¯ï¼ˆå¼‚æ­¥ï¼‰
await agent.run()

# ç›´æ¥å¤„ç†æ¶ˆæ¯ï¼ˆCLI ä½¿ç”¨ï¼‰
response = await agent.process_direct("ä½ å¥½", session_key="cli:test")
print(response)

# åœæ­¢å¾ªç¯
agent.stop()
```

### ToolRegistry

```python
from nanobot.agent.tools.registry import ToolRegistry
from nanobot.agent.tools.base import Tool

# åˆ›å»ºæ³¨å†Œè¡¨
registry = ToolRegistry()

# æ³¨å†Œå·¥å…·
registry.register(MyTool())

# è·å–å·¥å…·
tool = registry.get("tool_name")

# è·å–æ‰€æœ‰å·¥å…·å®šä¹‰ï¼ˆç”¨äº LLMï¼‰
definitions = registry.get_definitions()

# æ‰§è¡Œå·¥å…·
result = await registry.execute("tool_name", {"arg": "value"})
```

### ContextBuilder

```python
from nanobot.agent.context import ContextBuilder
from pathlib import Path

# åˆå§‹åŒ–
builder = ContextBuilder(workspace=Path.home() / ".nanobot")

# æ„å»ºç³»ç»Ÿæç¤º
system_prompt = builder.build_system_prompt(skill_names=["github", "weather"])

# æ„å»ºå®Œæ•´æ¶ˆæ¯åˆ—è¡¨
messages = builder.build_messages(
    history=[
        {"role": "user", "content": "ä¹‹å‰çš„æ¶ˆæ¯"},
        {"role": "assistant", "content": "ä¹‹å‰çš„å›å¤"}
    ],
    current_message="å½“å‰æ¶ˆæ¯",
    skill_names=["github"],
    media=["/path/to/image.jpg"]  # å¯é€‰ï¼Œå›¾ç‰‡é™„ä»¶
)

# æ·»åŠ å·¥å…·ç»“æœ
messages = builder.add_tool_result(
    messages=messages,
    tool_call_id="call_123",
    tool_name="read_file",
    result="æ–‡ä»¶å†…å®¹..."
)

# æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯
messages = builder.add_assistant_message(
    messages=messages,
    content="å›å¤å†…å®¹",
    tool_calls=[...]  # å¯é€‰
)
```

### SessionManager

```python
from nanobot.session.manager import SessionManager
from pathlib import Path

# åˆå§‹åŒ–
manager = SessionManager(workspace=Path.home() / ".nanobot")

# è·å–æˆ–åˆ›å»ºä¼šè¯
session = manager.get_or_create("telegram:123456")

# æ·»åŠ æ¶ˆæ¯
session.add_message("user", "ç”¨æˆ·æ¶ˆæ¯")
session.add_message("assistant", "åŠ©æ‰‹å›å¤")

# è·å–å†å²ï¼ˆLLM æ ¼å¼ï¼‰
history = session.get_history()

# ä¿å­˜ä¼šè¯
manager.save(session)
```

### MessageBus

```python
from nanobot.bus.queue import MessageBus
from nanobot.bus.events import InboundMessage, OutboundMessage

# åˆ›å»ºæ€»çº¿
bus = MessageBus()

# å‘å¸ƒå…¥ç«™æ¶ˆæ¯
await bus.publish_inbound(InboundMessage(
    channel="cli",
    sender_id="user",
    chat_id="123",
    content="æ¶ˆæ¯å†…å®¹",
    session_key="cli:123",
    media=["/path/to/image.jpg"]  # å¯é€‰
))

# æ¶ˆè´¹å…¥ç«™æ¶ˆæ¯ï¼ˆAgent ä½¿ç”¨ï¼‰
msg = await bus.consume_inbound()

# å‘å¸ƒå‡ºç«™æ¶ˆæ¯
await bus.publish_outbound(OutboundMessage(
    channel="telegram",
    chat_id="123",
    content="å›å¤å†…å®¹"
))

# è®¢é˜…å‡ºç«™æ¶ˆæ¯ï¼ˆChannel ä½¿ç”¨ï¼‰
bus.subscribe_outbound("telegram", my_callback)

# è¿è¡Œæ¶ˆæ¯åˆ†å‘ï¼ˆåå°ä»»åŠ¡ï¼‰
await bus.dispatch_outbound()
```

---

## CLI å‘½ä»¤é€ŸæŸ¥

### åˆå§‹åŒ–

```bash
# åˆå§‹åŒ–é…ç½®å’Œå·¥ä½œåŒº
nanobot onboard
```

### Agent å‘½ä»¤

```bash
# å•æ¬¡å¯¹è¯
nanobot agent -m "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±"

# äº¤äº’å¼å¯¹è¯
nanobot agent

# æŒ‡å®šä¼šè¯ ID
nanobot agent -s my-session -m "ç»§ç»­ä¹‹å‰çš„è¯é¢˜"
```

### ç½‘å…³æœåŠ¡

```bash
# å¯åŠ¨ç½‘å…³ï¼ˆæ”¯æŒ Telegram/WhatsAppï¼‰
nanobot gateway

# æŒ‡å®šç«¯å£
nanobot gateway --port 8080

# è¯¦ç»†è¾“å‡º
nanobot gateway --verbose
```

### æ¸ é“ç®¡ç†

```bash
# æŸ¥çœ‹æ¸ é“çŠ¶æ€
nanobot channels status

# ç™»å½• WhatsAppï¼ˆæ‰«æäºŒç»´ç ï¼‰
nanobot channels login
```

### å®šæ—¶ä»»åŠ¡

```bash
# åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡
nanobot cron list

# æ·»åŠ ä»»åŠ¡ï¼ˆä½¿ç”¨ cron è¡¨è¾¾å¼ï¼‰
nanobot cron add --name "morning" --message "æ—©ä¸Šå¥½ï¼" --cron "0 9 * * *"

# æ·»åŠ ä»»åŠ¡ï¼ˆä½¿ç”¨é—´éš”ç§’æ•°ï¼‰
nanobot cron add --name "hourly" --message "æ£€æŸ¥çŠ¶æ€" --every 3600

# åˆ é™¤ä»»åŠ¡
nanobot cron remove <job_id>

# å¯ç”¨/ç¦ç”¨ä»»åŠ¡
nanobot cron enable <job_id>
nanobot cron enable <job_id> --disable

# æ‰‹åŠ¨è¿è¡Œä»»åŠ¡
nanobot cron run <job_id>
```

### çŠ¶æ€æŸ¥çœ‹

```bash
# æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
nanobot status
```

---

## é…ç½®æ–‡ä»¶æ¨¡æ¿

### åŸºç¡€é…ç½® (`~/.nanobot/config.json`)

```json
{
  "providers": {
    "openrouter": {
      "apiKey": "sk-or-v1-YOUR_KEY_HERE"
    }
  },
  "agents": {
    "defaults": {
      "model": "anthropic/claude-opus-4-5"
    }
  },
  "tools": {
    "web": {
      "search": {
        "apiKey": "BSA-YOUR_BRAVE_API_KEY"
      }
    }
  }
}
```

### å®Œæ•´é…ç½®ç¤ºä¾‹

```json
{
  "providers": {
    "openrouter": {
      "apiKey": "sk-or-v1-xxx"
    },
    "groq": {
      "apiKey": "gsk_xxx"
    },
    "anthropic": {
      "apiKey": "sk-ant-xxx"
    },
    "openai": {
      "apiKey": "sk-xxx"
    }
  },
  "agents": {
    "defaults": {
      "model": "anthropic/claude-opus-4-5",
      "maxIterations": 20
    }
  },
  "channels": {
    "telegram": {
      "enabled": true,
      "token": "123456:ABC-DEF...",
      "allowFrom": ["123456789"]
    },
    "whatsapp": {
      "enabled": true,
      "allowFrom": ["+1234567890"]
    }
  },
  "tools": {
    "web": {
      "search": {
        "apiKey": "BSA-xxx"
      }
    }
  }
}
```

### æœ¬åœ°æ¨¡å‹é…ç½®ï¼ˆvLLMï¼‰

```json
{
  "providers": {
    "vllm": {
      "apiKey": "dummy",
      "apiBase": "http://localhost:8000/v1"
    }
  },
  "agents": {
    "defaults": {
      "model": "meta-llama/Llama-3.1-8B-Instruct"
    }
  }
}
```

---

## å·¥å…·å¼€å‘æ¨¡æ¿

### åŸºç¡€å·¥å…·æ¨¡æ¿

```python
from typing import Any
from nanobot.agent.tools.base import Tool

class MyTool(Tool):
    """å·¥å…·æè¿°"""
    
    @property
    def name(self) -> str:
        """å·¥å…·åç§°ï¼ˆLLM è°ƒç”¨æ—¶ä½¿ç”¨ï¼‰"""
        return "my_tool"
    
    @property
    def description(self) -> str:
        """å·¥å…·åŠŸèƒ½æè¿°ï¼ˆå‘Šè¯‰ LLM è¿™ä¸ªå·¥å…·æ˜¯åšä»€ä¹ˆçš„ï¼‰"""
        return "è¿™ä¸ªå·¥å…·å¯ä»¥åšæŸæŸäº‹æƒ…"
    
    @property
    def parameters(self) -> dict[str, Any]:
        """å‚æ•°å®šä¹‰ï¼ˆJSON Schema æ ¼å¼ï¼‰"""
        return {
            "type": "object",
            "properties": {
                "arg1": {
                    "type": "string",
                    "description": "å‚æ•°1çš„å«ä¹‰"
                },
                "arg2": {
                    "type": "integer",
                    "description": "å‚æ•°2çš„å«ä¹‰",
                    "default": 10
                }
            },
            "required": ["arg1"]
        }
    
    async def execute(self, arg1: str, arg2: int = 10) -> str:
        """
        æ‰§è¡Œå·¥å…·é€»è¾‘
        
        å‚æ•°ï¼š
            arg1: ç¬¬ä¸€ä¸ªå‚æ•°
            arg2: ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰
        
        è¿”å›ï¼š
            æ‰§è¡Œç»“æœï¼ˆå­—ç¬¦ä¸²ï¼‰
        """
        try:
            # ä½ çš„é€»è¾‘
            result = f"å¤„ç† {arg1} å¹¶ä½¿ç”¨å‚æ•° {arg2}"
            return result
        except Exception as e:
            return f"Error: {str(e)}"

# æ³¨å†Œå·¥å…·
agent.tools.register(MyTool())
```

### å¸¦å¤–éƒ¨ API çš„å·¥å…·

```python
import httpx
from nanobot.agent.tools.base import Tool

class WeatherTool(Tool):
    def __init__(self, api_key: str):
        self.api_key = api_key
    
    @property
    def name(self) -> str:
        return "get_weather"
    
    @property
    def description(self) -> str:
        return "è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯"
    
    @property
    def parameters(self) -> dict[str, Any]:
        return {
            "type": "object",
            "properties": {
                "city": {
                    "type": "string",
                    "description": "åŸå¸‚åç§°ï¼ˆå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ï¼‰"
                }
            },
            "required": ["city"]
        }
    
    async def execute(self, city: str) -> str:
        try:
            async with httpx.AsyncClient() as client:
                response = await client.get(
                    f"https://api.example.com/weather",
                    params={"city": city, "key": self.api_key}
                )
                response.raise_for_status()
                data = response.json()
                
                return f"{city}çš„å¤©æ°”ï¼š{data['weather']}, æ¸©åº¦ï¼š{data['temp']}Â°C"
        except httpx.HTTPError as e:
            return f"æ— æ³•è·å–å¤©æ°”ä¿¡æ¯ï¼š{str(e)}"

# æ³¨å†Œ
agent.tools.register(WeatherTool(api_key="YOUR_API_KEY"))
```

---

## æŠ€èƒ½å¼€å‘æ¨¡æ¿

### æŠ€èƒ½ç›®å½•ç»“æ„

```
~/.nanobot/skills/my-skill/
â”œâ”€â”€ SKILL.md          # æŠ€èƒ½å®šä¹‰ï¼ˆå¿…éœ€ï¼‰
â”œâ”€â”€ script.py         # å¯é€‰è„šæœ¬
â””â”€â”€ resources/        # å¯é€‰èµ„æº
    â””â”€â”€ data.json
```

### SKILL.md æ¨¡æ¿

````markdown
---
name: my-skill
description: æŠ€èƒ½çš„ç®€çŸ­æè¿°
available: true
---

# my-skill

å®Œæ•´çš„æŠ€èƒ½è¯´æ˜ã€‚

## ç”¨é€”

è¿™ä¸ªæŠ€èƒ½ç”¨äº...

## ä½¿ç”¨æ–¹æ³•

è°ƒç”¨æ–¹å¼ï¼š
\```bash
python ~/.nanobot/skills/my-skill/script.py arg1 arg2
\```

## ç¤ºä¾‹

\```
ç”¨æˆ·: è¯·ä½¿ç”¨ my-skill åšæŸäº‹
åŠ©æ‰‹: [è¯»å–æ­¤æ–‡ä»¶] å¥½çš„ï¼Œæˆ‘ä¼šä½¿ç”¨è„šæœ¬...
\```

## ä¾èµ–

- Python åŒ…: requests, beautifulsoup4
- ç³»ç»Ÿå‘½ä»¤: curl

## å‚æ•°

- `arg1`: ç¬¬ä¸€ä¸ªå‚æ•°çš„è¯´æ˜
- `arg2`: ç¬¬äºŒä¸ªå‚æ•°çš„è¯´æ˜ï¼ˆå¯é€‰ï¼‰
````

### æŠ€èƒ½è„šæœ¬æ¨¡æ¿

```python
#!/usr/bin/env python3
"""
my-skill è„šæœ¬

ç”¨æ³•ï¼š
    python script.py <arg1> <arg2>
"""

import sys
import json

def main():
    if len(sys.argv) < 2:
        print("Usage: script.py <arg1> [arg2]", file=sys.stderr)
        sys.exit(1)
    
    arg1 = sys.argv[1]
    arg2 = sys.argv[2] if len(sys.argv) > 2 else None
    
    # ä½ çš„é€»è¾‘
    result = process(arg1, arg2)
    
    # è¾“å‡ºç»“æœï¼ˆJSON æˆ–çº¯æ–‡æœ¬ï¼‰
    print(json.dumps(result, ensure_ascii=False))

def process(arg1, arg2=None):
    """å¤„ç†é€»è¾‘"""
    return {"status": "success", "data": "..."}

if __name__ == "__main__":
    main()
```

---

## å¸¸è§é—®é¢˜é€ŸæŸ¥

### Q: å¦‚ä½•ä¿®æ”¹é»˜è®¤æ¨¡å‹ï¼Ÿ

**A:** ç¼–è¾‘ `~/.nanobot/config.json`ï¼š

```json
{
  "agents": {
    "defaults": {
      "model": "anthropic/claude-sonnet-4-5"
    }
  }
}
```

### Q: å¦‚ä½•å¯ç”¨ Web æœç´¢ï¼Ÿ

**A:** æ·»åŠ  Brave Search API Keyï¼š

```json
{
  "tools": {
    "web": {
      "search": {
        "apiKey": "BSA-YOUR_KEY"
      }
    }
  }
}
```

### Q: å¦‚ä½•æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼Ÿ

**A:** ä½¿ç”¨ `--verbose` å‚æ•°ï¼š

```bash
nanobot gateway --verbose
```

æˆ–åœ¨ä»£ç ä¸­è®¾ç½®æ—¥å¿—çº§åˆ«ï¼š

```python
from loguru import logger
logger.remove()
logger.add(sys.stderr, level="DEBUG")
```

### Q: å·¥å…·è¿”å›å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²å—ï¼Ÿ

**A:** æ˜¯çš„ã€‚LLM æœŸæœ›å­—ç¬¦ä¸²æ ¼å¼çš„ç»“æœã€‚å¦‚æœä½ çš„å·¥å…·è¿”å›å¤æ‚æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ JSONï¼š

```python
async def execute(self, **kwargs) -> str:
    result = {"status": "ok", "data": [...]}
    return json.dumps(result, ensure_ascii=False)
```

### Q: å¦‚ä½•é™åˆ¶å·¥å…·æ‰§è¡Œæ—¶é—´ï¼Ÿ

**A:** ä½¿ç”¨ `asyncio.wait_for`ï¼š

```python
async def execute(self, **kwargs) -> str:
    try:
        result = await asyncio.wait_for(
            self.long_running_task(**kwargs),
            timeout=30.0
        )
        return result
    except asyncio.TimeoutError:
        return "æ“ä½œè¶…æ—¶"
```

### Q: ä¼šè¯ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ

**A:** é»˜è®¤ä¿å­˜åœ¨ `~/.nanobot/sessions/` ç›®å½•ï¼Œæ¯ä¸ªä¼šè¯ä¸€ä¸ª JSON æ–‡ä»¶ã€‚

### Q: å¦‚ä½•æ¸…ç©ºä¼šè¯å†å²ï¼Ÿ

**A:** åˆ é™¤å¯¹åº”çš„ä¼šè¯æ–‡ä»¶ï¼š

```bash
rm ~/.nanobot/sessions/cli:default.json
```

### Q: å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ª LLM æä¾›å•†å—ï¼Ÿ

**A:** å¯ä»¥ã€‚é…ç½®å¤šä¸ªæä¾›å•†ï¼Œç„¶ååœ¨è¿è¡Œæ—¶æŒ‡å®šï¼š

```python
provider1 = LiteLLMProvider(api_key="...", default_model="anthropic/...")
provider2 = LiteLLMProvider(api_key="...", default_model="openai/...")

agent1 = AgentLoop(bus, provider1, workspace, model="anthropic/claude-opus-4-5")
agent2 = AgentLoop(bus, provider2, workspace, model="openai/gpt-4")
```

### Q: å¦‚ä½•ç¦ç”¨æŸä¸ªå·¥å…·ï¼Ÿ

**A:** ä¸æ³¨å†Œå³å¯ï¼š

```python
# ä¸è°ƒç”¨ self.tools.register(UnwantedTool())
```

æˆ–è€…åˆ›å»ºä¸€ä¸ªè¿‡æ»¤çš„æ³¨å†Œè¡¨ï¼š

```python
class FilteredToolRegistry(ToolRegistry):
    def register(self, tool: Tool):
        if tool.name not in ["unwanted_tool"]:
            super().register(tool)
```

### Q: æŠ€èƒ½å’Œå·¥å…·çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

**A:**
- **å·¥å…·ï¼ˆToolï¼‰**ï¼šPython ä»£ç å®ç°çš„åŠŸèƒ½ï¼ŒAgent å¯ä»¥ç›´æ¥è°ƒç”¨
- **æŠ€èƒ½ï¼ˆSkillï¼‰**ï¼šMarkdown æ–‡æ¡£ + å¯é€‰è„šæœ¬ï¼ŒAgent é€šè¿‡ `read_file` è¯»å–åä½¿ç”¨

æŠ€èƒ½æ›´çµæ´»ï¼Œä½†éœ€è¦ Agent è‡ªå·±ç†è§£å¦‚ä½•ä½¿ç”¨ï¼›å·¥å…·æ›´ç›´æ¥ï¼Œä½†éœ€è¦ç¼–å†™ä»£ç ã€‚

---

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ LLM çš„åŸå§‹è¯·æ±‚å’Œå“åº”

```python
from loguru import logger

# åœ¨è°ƒç”¨å‰
logger.debug(f"Messages to LLM: {json.dumps(messages, indent=2)}")

response = await provider.chat(messages, tools=...)

# åœ¨è°ƒç”¨å
logger.debug(f"LLM response: {response}")
```

### 2. æ£€æŸ¥å·¥å…·å®šä¹‰

```python
definitions = agent.tools.get_definitions()
print(json.dumps(definitions, indent=2))
```

### 3. æ‰‹åŠ¨æµ‹è¯•å·¥å…·

```python
import asyncio

tool = MyTool()
result = asyncio.run(tool.execute(arg1="test"))
print(result)
```

### 4. æŸ¥çœ‹ä¼šè¯å†å²

```python
session = agent.sessions.get_or_create("cli:default")
print(json.dumps(session.get_history(), indent=2))
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å‡å°‘ Token ä½¿ç”¨

- é™åˆ¶å†å²æ¶ˆæ¯æ•°é‡
- ç²¾ç®€ç³»ç»Ÿæç¤º
- ä½¿ç”¨æ›´å°çš„æ¨¡å‹

### 2. åŠ é€Ÿå·¥å…·æ‰§è¡Œ

- ä½¿ç”¨å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ï¼ˆhttpxï¼‰
- å¹¶å‘æ‰§è¡Œç‹¬ç«‹çš„å·¥å…·è°ƒç”¨
- æ·»åŠ ç¼“å­˜æœºåˆ¶

### 3. é™ä½å»¶è¿Ÿ

- ä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼ˆvLLMï¼‰
- å‡å°‘å·¥å…·æ•°é‡ï¼ˆåªæ³¨å†Œéœ€è¦çš„ï¼‰
- ä¼˜åŒ–æç¤ºè¯é•¿åº¦

---

**è¿™ä»½é€ŸæŸ¥æ‰‹å†Œåº”è¯¥èƒ½å¸®åŠ©ä½ å¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„ä¿¡æ¯ã€‚å¦‚æœéœ€è¦æ›´è¯¦ç»†çš„è§£é‡Šï¼Œè¯·å‚è€ƒå®Œæ•´çš„å­¦ä¹ æ–‡æ¡£ã€‚** ğŸ“–
