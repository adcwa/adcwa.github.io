# ç¬¬äºŒå±‚ï¼šé…ç½®ç³»ç»Ÿ

> ğŸ“Œ **æ ¸å¿ƒæ–‡ä»¶**ï¼š  
> - `nanobot/config/schema.py` - é…ç½®æ•°æ®æ¨¡å‹  
> - `nanobot/config/loader.py` - é…ç½®åŠ è½½å™¨

## æ¦‚è¿°

nanobot ä½¿ç”¨åŸºäº Pydantic çš„é…ç½®ç³»ç»Ÿï¼Œç‰¹ç‚¹ï¼š
- å•ä¸€ JSON é…ç½®æ–‡ä»¶ï¼ˆ`~/.nanobot/config.json`ï¼‰
- ç±»å‹å®‰å…¨çš„é…ç½®æ¨¡å‹
- è‡ªåŠ¨éªŒè¯é…ç½®æ­£ç¡®æ€§
- æ”¯æŒåµŒå¥—é…ç½®ç»“æ„

## é…ç½®æ¨¡å‹å®šä¹‰

### å®Œæ•´çš„é…ç½®ç»“æ„

```python
from pydantic import BaseModel, Field
from typing import Dict, Optional

class ProviderConfig(BaseModel):
    """å•ä¸ªæä¾›å•†é…ç½®"""
    apiKey: str
    apiBase: Optional[str] = None

class AgentDefaults(BaseModel):
    """Agent é»˜è®¤è®¾ç½®"""
    model: str = "anthropic/claude-opus-4-5"
    maxIterations: int = 20

class TelegramConfig(BaseModel):
    """Telegram é…ç½®"""
    enabled: bool = False
    token: Optional[str] = None
    allowFrom: list[str] = Field(default_factory=list)

class WhatsAppConfig(BaseModel):
    """WhatsApp é…ç½®"""
    enabled: bool = False
    allowFrom: list[str] = Field(default_factory=list)

class WebSearchConfig(BaseModel):
    """Web æœç´¢é…ç½®"""
    apiKey: Optional[str] = None

class Config(BaseModel):
    """æ ¹é…ç½®æ¨¡å‹"""
    providers: Dict[str, ProviderConfig] = Field(default_factory=dict)
    agents: AgentDefaults = Field(default_factory=AgentDefaults)
    channels: ChannelsConfig = Field(default_factory=ChannelsConfig)
    tools: ToolsConfig = Field(default_factory=ToolsConfig)
```

### é…ç½®ç¤ºä¾‹

```json
{
  "providers": {
    "openrouter": {
      "apiKey": "sk-or-v1-xxx",
      "apiBase": null
    },
    "groq": {
      "apiKey": "gsk_xxx"
    }
  },
  "agents": {
    "defaults": {
      "model": "anthropic/claude-opus-4-5",
      "maxIterations": 20
    }
  },
  "channels": {
    "telegram": {
      "enabled": true,
      "token": "123456:ABC...",
      "allowFrom": ["123456789"]
    },
    "whatsapp": {
      "enabled": false,
      "allowFrom": []
    }
  },
  "tools": {
    "web": {
      "search": {
        "apiKey": "BSA-xxx"
      }
    }
  }
}
```

## é…ç½®åŠ è½½å™¨

```python
class ConfigLoader:
    """é…ç½®åŠ è½½å™¨"""
    
    def __init__(self, config_path: Path | None = None):
        self.config_path = config_path or (Path.home() / ".nanobot" / "config.json")
    
    def load(self) -> Config:
        """åŠ è½½å¹¶éªŒè¯é…ç½®"""
        if not self.config_path.exists():
            raise FileNotFoundError(f"Config not found: {self.config_path}")
        
        # è¯»å– JSON
        data = json.loads(self.config_path.read_text())
        
        # Pydantic è‡ªåŠ¨éªŒè¯
        try:
            config = Config(**data)
            return config
        except ValidationError as e:
            logger.error(f"Config validation failed: {e}")
            raise
    
    def save(self, config: Config):
        """ä¿å­˜é…ç½®"""
        self.config_path.write_text(
            config.model_dump_json(indent=2, exclude_none=True)
        )
```

## é…ç½®éªŒè¯

Pydantic è‡ªåŠ¨éªŒè¯æ•°æ®ç±»å‹å’Œçº¦æŸï¼š

```python
# âŒ é”™è¯¯çš„é…ç½®
{
  "agents": {
    "defaults": {
      "maxIterations": "twenty"  # åº”è¯¥æ˜¯æ•´æ•°
    }
  }
}

# æŠ›å‡º ValidationError:
# validation error for Config
# agents -> defaults -> maxIterations
#   value is not a valid integer
```

## ç¯å¢ƒå˜é‡æ”¯æŒ

è™½ç„¶å½“å‰å®ç°ä¸ç›´æ¥æ”¯æŒç¯å¢ƒå˜é‡ï¼Œä½†å¯ä»¥è½»æ¾æ‰©å±•ï¼š

```python
class ProviderConfig(BaseModel):
    apiKey: str
    
    @field_validator('apiKey')
    def resolve_env_var(cls, v):
        """æ”¯æŒ ${ENV_VAR} è¯­æ³•"""
        if v.startswith("${") and v.endswith("}"):
            env_var = v[2:-1]
            return os.getenv(env_var, "")
        return v
```

## é…ç½®è®¿é—®æ¨¡å¼

```python
# åŠ è½½é…ç½®
config = ConfigLoader().load()

# è®¿é—®é…ç½®
model = config.agents.defaults.model
api_key = config.providers.get("openrouter").apiKey
telegram_enabled = config.channels.telegram.enabled

# ä¿®æ”¹é…ç½®
config.agents.defaults.model = "anthropic/claude-sonnet-4-5"
ConfigLoader().save(config)
```

## å°ç»“

- âœ… åŸºäº Pydantic çš„ç±»å‹å®‰å…¨é…ç½®
- âœ… å•ä¸€ JSON æ–‡ä»¶ï¼Œç®€å•ç›´è§‚
- âœ… è‡ªåŠ¨éªŒè¯ï¼Œé˜²æ­¢é”™è¯¯é…ç½®

**ä¸‹ä¸€æ­¥**ï¼š[04-æ¶ˆæ¯æ€»çº¿.md](./nanobot/2026-02-03/04-æ¶ˆæ¯æ€»çº¿.md)
