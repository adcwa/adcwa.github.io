# ç¬¬äº”å±‚ï¼šå­ä»£ç†ç³»ç»Ÿ

> ğŸ“Œ **æ ¸å¿ƒæ–‡ä»¶**ï¼š`nanobot/agent/subagent.py`

## æ¦‚è¿°

å­ä»£ç†ï¼ˆSubagentï¼‰ç³»ç»Ÿå…è®¸ä¸» Agent æ´¾ç”Ÿç‹¬ç«‹çš„åå° Agent æ¥å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œå®ç°çœŸæ­£çš„å¹¶å‘å¤„ç†å’Œå¼‚æ­¥é€šçŸ¥ã€‚

## ä½¿ç”¨åœºæ™¯

### é€‚åˆå­ä»£ç†çš„ä»»åŠ¡

âœ… **é•¿æ—¶é—´è¿è¡Œ**ï¼š
- å®šæœŸç›‘æ§æœåŠ¡çŠ¶æ€
- ç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿ
- æ‰¹é‡å¤„ç†å¤§é‡æ•°æ®

âœ… **å¼‚æ­¥é€šçŸ¥**ï¼š
- å®Œæˆåä¸»åŠ¨é€šçŸ¥ç”¨æˆ·
- å‘ç°å¼‚å¸¸æ—¶åŠæ—¶è­¦å‘Š

âœ… **ç‹¬ç«‹ä»»åŠ¡**ï¼š
- ä¸å½±å“ä¸»å¯¹è¯æµç¨‹
- å¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šä¸ª

### ä¸é€‚åˆå­ä»£ç†çš„ä»»åŠ¡

âŒ éœ€è¦ç«‹å³ç»“æœçš„æ“ä½œ  
âŒ ç®€å•çš„åŒæ­¥ä»»åŠ¡  
âŒ éœ€è¦é¢‘ç¹äº¤äº’çš„ä»»åŠ¡

## æ ¸å¿ƒæ¶æ„

```mermaid
graph TB
    User[ç”¨æˆ·] -->|1. è¯·æ±‚ä»»åŠ¡| Main[ä¸» Agent]
    Main -->|2. spawn å·¥å…·| SM[SubagentManager]
    SM -->|3. åˆ›å»º| Sub1[å­ä»£ç† 1]
    SM -->|3. åˆ›å»º| Sub2[å­ä»£ç† 2]
    
    Sub1 -.->|4. åå°è¿è¡Œ| Loop1[ç‹¬ç«‹ AgentLoop]
    Sub2 -.->|4. åå°è¿è¡Œ| Loop2[ç‹¬ç«‹ AgentLoop]
    
    Loop1 -->|5. å®Œæˆ/é€šçŸ¥| Bus[MessageBus]
    Loop2 -->|5. å®Œæˆ/é€šçŸ¥| Bus
    
    Bus -->|6. åˆ†å‘| Channel[Telegram/WhatsApp]
    Channel -->|7. é€šçŸ¥| User
    
    Main -->|åŒæ—¶| User
```

## SubagentManager å®ç°

### æ ¸å¿ƒç±»

```python
class SubagentManager:
    """ç®¡ç†æ‰€æœ‰å­ä»£ç†"""
    
    def __init__(self, provider, workspace, bus, model, brave_api_key=None):
        self.provider = provider
        self.workspace = workspace
        self.bus = bus
        self.model = model
        self.brave_api_key = brave_api_key
        self._subagents: dict[str, asyncio.Task] = {}
    
    async def spawn(
        self,
        task: str,
        origin: str,  # åŸå§‹å¯¹è¯æ ‡è¯† "channel:chat_id"
        announce: bool = True
    ) -> str:
        """
        ç”Ÿæˆæ–°çš„å­ä»£ç†
        
        Args:
            task: ä»»åŠ¡æè¿°
            origin: å®Œæˆåé€šçŸ¥çš„ç›®æ ‡
            announce: æ˜¯å¦åœ¨å®Œæˆåé€šçŸ¥
        
        Returns:
            å­ä»£ç† ID
        """
        subagent_id = str(uuid.uuid4())[:8]
        
        # åˆ›å»ºç‹¬ç«‹çš„ AgentLoop
        subagent_loop = AgentLoop(
            bus=self.bus,
            provider=self.provider,
            workspace=self.workspace,
            model=self.model,
            brave_api_key=self.brave_api_key
        )
        
        # åœ¨åå°è¿è¡Œ
        task_coro = self._run_subagent(
            subagent_loop,
            task,
            origin,
            announce,
            subagent_id
        )
        
        self._subagents[subagent_id] = asyncio.create_task(task_coro)
        
        logger.info(f"Spawned subagent {subagent_id} for task: {task}")
        return subagent_id
    
    async def _run_subagent(
        self,
        loop: AgentLoop,
        task: str,
        origin: str,
        announce: bool,
        subagent_id: str
    ):
        """è¿è¡Œå­ä»£ç†ç›´åˆ°å®Œæˆ"""
        try:
            # å¤„ç†ä»»åŠ¡
            session_key = f"subagent:{subagent_id}"
            result = await loop.process_direct(task, session_key)
            
            # å¦‚æœéœ€è¦é€šçŸ¥
            if announce and origin:
                channel, chat_id = origin.split(":", 1)
                await self.bus.publish_outbound(OutboundMessage(
                    channel=channel,
                    chat_id=chat_id,
                    content=f"ğŸ¤– å­ä»£ç† {subagent_id} å®Œæˆä»»åŠ¡ï¼š\n\n{result}"
                ))
        
        except Exception as e:
            logger.error(f"Subagent {subagent_id} failed: {e}")
        
        finally:
            # æ¸…ç†
            self._subagents.pop(subagent_id, None)
```

## SpawnTool å®ç°

```python
class SpawnTool(Tool):
    """ç”Ÿæˆå­ä»£ç†çš„å·¥å…·"""
    
    def __init__(self, manager: SubagentManager):
        self.manager = manager
        self._channel = None
        self._chat_id = None
    
    def set_context(self, channel: str, chat_id: str):
        """è®¾ç½®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆä»ä¸» Agent ä¼ å…¥ï¼‰"""
        self._channel = channel
        self._chat_id = chat_id
    
    @property
    def name(self) -> str:
        return "spawn"
    
    @property
    def description(self) -> str:
        return "Spawn a subagent to handle a task in the background."
    
    @property
    def parameters(self) -> dict:
        return {
            "type": "object",
            "properties": {
                "task": {
                    "type": "string",
                    "description": "ä»»åŠ¡æè¿°"
                },
                "announce": {
                    "type": "boolean",
                    "description": "å®Œæˆåæ˜¯å¦é€šçŸ¥ç”¨æˆ·",
                    "default": True
                }
            },
            "required": ["task"]
        }
    
    async def execute(self, task: str, announce: bool = True) -> str:
        origin = f"{self._channel}:{self._chat_id}"
        
        subagent_id = await self.manager.spawn(
            task=task,
            origin=origin,
            announce=announce
        )
        
        return f"å·²æ´¾ç”Ÿå­ä»£ç† {subagent_id} å¤„ç†ä»»åŠ¡ï¼š{task}"
```

## å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ 1ï¼šå®šæœŸç›‘æ§

**ç”¨æˆ·**ï¼š**"æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ example.com æ˜¯å¦åœ¨çº¿"**

```python
# ä¸» Agent ç†è§£åè°ƒç”¨
{
  "name": "spawn",
  "arguments": {
    "task": "æ¯å°æ—¶è®¿é—® https://example.comï¼Œå¦‚æœè¿”å›é 200 çŠ¶æ€ç åˆ™é€šçŸ¥æˆ‘",
    "announce": true
  }
}

# è¿”å›
"å·²æ´¾ç”Ÿå­ä»£ç† a1b2c3d4 å¤„ç†ä»»åŠ¡ï¼šæ¯å°æ—¶è®¿é—®..."

# å­ä»£ç†åœ¨åå°è¿è¡Œ
while True:
    status = await check_website("https://example.com")
    if status != 200:
        # é€šè¿‡æ¶ˆæ¯æ€»çº¿é€šçŸ¥ç”¨æˆ·
        await bus.publish_outbound(OutboundMessage(
            channel="telegram",
            chat_id="123456",
            content=f"âš ï¸ ç½‘ç«™ç¦»çº¿ï¼çŠ¶æ€ç ï¼š{status}"
        ))
    await asyncio.sleep(3600)  # ç­‰å¾… 1 å°æ—¶
```

### åœºæ™¯ 2ï¼šå¤§æ–‡ä»¶å¤„ç†

**ç”¨æˆ·**ï¼š**"ä¸‹è½½å¹¶å¤„ç†è¿™ä¸ª 10GB çš„æ•°æ®é›†"**

```python
# ä¸» Agent
{
  "name": "spawn",
  "arguments": {
    "task": "ä¸‹è½½ https://data.example.com/dataset.zip å¹¶è§£å‹ã€æ¸…æ´—ï¼Œå®Œæˆåé€šçŸ¥æˆ‘",
    "announce": true
  }
}

# å­ä»£ç†ç‹¬ç«‹è¿è¡Œ
await exec("wget https://data.example.com/dataset.zip")  # 30 åˆ†é’Ÿ
await exec("unzip dataset.zip")                          # 10 åˆ†é’Ÿ
await exec("python clean_data.py")                       # 1 å°æ—¶

# å®Œæˆåè‡ªåŠ¨é€šçŸ¥ï¼š
"ğŸ¤– å­ä»£ç† x7y8z9 å®Œæˆä»»åŠ¡ï¼š
æ•°æ®é›†å·²ä¸‹è½½å¹¶æ¸…æ´—å®Œæˆï¼Œå…± 1,234,567 æ¡è®°å½•ã€‚"
```

### åœºæ™¯ 3ï¼šå¤šä»»åŠ¡å¹¶è¡Œ

```python
# ç”¨æˆ·åŒæ—¶å‘èµ· 3 ä¸ªä»»åŠ¡

ä»»åŠ¡ 1ï¼šspawn(task="ç›‘æ§æœåŠ¡å™¨ A")
ä»»åŠ¡ 2ï¼šspawn(task="ç›‘æ§æœåŠ¡å™¨ B")
ä»»åŠ¡ 3ï¼šspawn(task="æ¯å¤©ç”ŸæˆæŠ¥å‘Š")

# 3 ä¸ªå­ä»£ç†åŒæ—¶è¿è¡Œï¼Œäº’ä¸å¹²æ‰°
SubagentManager._subagents = {
    "aaa111": <Task for ä»»åŠ¡ 1>,
    "bbb222": <Task for ä»»åŠ¡ 2>,
    "ccc333": <Task for ä»»åŠ¡ 3>
}
```

## ä¸å®šæ—¶ä»»åŠ¡çš„å¯¹æ¯”

| ç»´åº¦ | å­ä»£ç†ï¼ˆSubagentï¼‰ | å®šæ—¶ä»»åŠ¡ï¼ˆCronï¼‰ |
|------|--------------------|------------------|
| **è§¦å‘æ–¹å¼** | å¯¹è¯ä¸­åŠ¨æ€åˆ›å»º | é¢„å…ˆé…ç½® |
| **çµæ´»æ€§** | é«˜ï¼ˆLLMç†è§£ä»»åŠ¡ï¼‰ | ä½ï¼ˆå›ºå®šæ¶ˆæ¯ï¼‰ |
| **ç”Ÿå‘½å‘¨æœŸ** | ä¸´æ—¶ï¼ˆå¯èƒ½ä¸€æ¬¡æ€§ï¼‰ | æŒä¹…ï¼ˆå‘¨æœŸæ€§ï¼‰ |
| **å¤æ‚åº¦** | å¯ä»¥å¾ˆå¤æ‚ | é€šå¸¸ç®€å• |
| **é€‚ç”¨åœºæ™¯** | ä¸´æ—¶çš„å¤æ‚åå°ä»»åŠ¡ | å®šæœŸçš„ç®€å•æé†’ |

## å®ç°ç»†èŠ‚

### 1. ç‹¬ç«‹çš„ä¼šè¯

æ¯ä¸ªå­ä»£ç†æœ‰ç‹¬ç«‹çš„ä¼šè¯ï¼š

```python
session_key = f"subagent:{subagent_id}"
```

å¯¹è¯å†å²ä¿å­˜åœ¨ï¼š
```
~/.nanobot/sessions/subagent:a1b2c3d4.json
```

### 2. å…±äº«å·¥å…·å’ŒæŠ€èƒ½

å­ä»£ç†ä½¿ç”¨ç›¸åŒçš„ï¼š
- LLM Provider
- å·¥å…·æ³¨å†Œè¡¨
- æŠ€èƒ½åŠ è½½å™¨
- å·¥ä½œåŒº

### 3. åå°è¿è¡Œ

```python
# ä½¿ç”¨ asyncio.create_task åœ¨åå°è¿è¡Œ
task = asyncio.create_task(self._run_subagent(...))

# ä¸» Agent ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…å­ä»£ç†å®Œæˆ
```

### 4. é€šçŸ¥æœºåˆ¶

```python
# é€šè¿‡æ¶ˆæ¯æ€»çº¿å‘é€é€šçŸ¥
await self.bus.publish_outbound(OutboundMessage(
    channel=original_channel,
    chat_id=original_chat_id,
    content=f"å­ä»£ç†å®Œæˆï¼š{result}"
))

# æ¶ˆæ¯æ€»çº¿åˆ†å‘åˆ°å¯¹åº”æ¸ é“
# ç”¨æˆ·æ”¶åˆ°é€šçŸ¥
```

## æœ€ä½³å®è·µ

### 1. æ˜ç¡®ä»»åŠ¡ç›®æ ‡

```markdown
# âœ… å¥½çš„ä»»åŠ¡æè¿°
"æ¯ 30 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ GitHub Actions çš„çŠ¶æ€ï¼Œ
å¦‚æœæœ‰å¤±è´¥çš„ workflow å°±é€šçŸ¥æˆ‘ï¼Œ
å¹¶é™„ä¸Šå¤±è´¥çš„æ—¥å¿—é“¾æ¥ã€‚"

# âŒ ä¸å¥½çš„ä»»åŠ¡æè¿°
"ç›‘æ§ CI"
```

### 2. è®¾ç½®ç»ˆæ­¢æ¡ä»¶

```markdown
# âœ… æœ‰æ˜ç¡®ç»ˆæ­¢æ¡ä»¶
"ç›‘æ§æœåŠ¡å™¨ï¼Œå¦‚æœ CPU è¶…è¿‡ 80% è¿ç»­ 5 åˆ†é’Ÿåˆ™é€šçŸ¥æˆ‘ï¼Œ
ç„¶ååœæ­¢ç›‘æ§ã€‚"

# âŒ æ— é™å¾ªç¯
"ä¸€ç›´ç›‘æ§æœåŠ¡å™¨"  # å¯èƒ½æ°¸ä¸ç»ˆæ­¢
```

### 3. åˆç†ä½¿ç”¨ announce

```python
# éœ€è¦é€šçŸ¥
spawn(task="ä¸‹è½½æ–‡ä»¶", announce=True)   # å®Œæˆåé€šçŸ¥

# ä¸éœ€è¦é€šçŸ¥
spawn(task="é™é»˜æ¸…ç†æ—¥å¿—", announce=False)  # åå°æ‰§è¡Œå³å¯
```

## è°ƒè¯•å’Œç›‘æ§

### æŸ¥çœ‹æ´»åŠ¨çš„å­ä»£ç†

```python
def list_subagents(self) -> list[str]:
    """åˆ—å‡ºæ‰€æœ‰æ´»åŠ¨çš„å­ä»£ç† ID"""
    return list(self._subagents.keys())

# ä½¿ç”¨
active = manager.list_subagents()
print(f"æ´»åŠ¨å­ä»£ç†ï¼š{active}")
```

### åœæ­¢å­ä»£ç†

```python
async def stop_subagent(self, subagent_id: str):
    """åœæ­¢æŒ‡å®šçš„å­ä»£ç†"""
    task = self._subagents.get(subagent_id)
    if task:
        task.cancel()
        self._subagents.pop(subagent_id)
```

### æ—¥å¿—è®°å½•

```python
logger.info(f"Spawned subagent {subagent_id}")
logger.info(f"Subagent {subagent_id} completed")
logger.error(f"Subagent {subagent_id} failed: {e}")
```

## æœªæ¥ä¼˜åŒ–

### 1. æŒä¹…åŒ–å­ä»£ç†çŠ¶æ€

å½“å‰å®ç°åœ¨è¿›ç¨‹é‡å¯åå­ä»£ç†ä¼šä¸¢å¤±ï¼Œå¯ä»¥æ”¹è¿›ï¼š

```python
# ä¿å­˜å­ä»£ç†çŠ¶æ€åˆ°æ–‡ä»¶
{
  "id": "a1b2c3d4",
  "task": "ç›‘æ§æœåŠ¡å™¨",
  "origin": "telegram:123456",
  "created_at": "2026-02-03T10:00:00Z",
  "status": "running"
}

# é‡å¯åæ¢å¤
async def restore_subagents(self):
    for state in load_subagent_states():
        await self.spawn(state["task"], state["origin"])
```

### 2. èµ„æºé™åˆ¶

```python
MAX_SUBAGENTS = 10

async def spawn(self, task, origin, announce=True):
    if len(self._subagents) >= MAX_SUBAGENTS:
        return "Error: å·²è¾¾åˆ°æœ€å¤§å­ä»£ç†æ•°é‡é™åˆ¶"
```

### 3. è¶…æ—¶æ§åˆ¶

```python
async def _run_subagent(self, ..., timeout=3600):
    try:
        await asyncio.wait_for(
            loop.process_direct(task, session_key),
            timeout=timeout
        )
    except asyncio.TimeoutError:
        logger.warning(f"Subagent {subagent_id} timeout")
```

## å°ç»“

- âœ… å­ä»£ç†å®ç°çœŸæ­£çš„å¹¶å‘åå°ä»»åŠ¡
- âœ… ç‹¬ç«‹çš„ AgentLoopï¼Œå…±äº«èµ„æº
- âœ… è‡ªåŠ¨é€šçŸ¥æœºåˆ¶
- âœ… é€‚åˆé•¿æ—¶é—´è¿è¡Œã€å¼‚æ­¥é€šçŸ¥çš„åœºæ™¯
- âœ… ä¸å®šæ—¶ä»»åŠ¡äº’è¡¥

**ä¸‹ä¸€æ­¥**ï¼š[12-è®°å¿†ç³»ç»Ÿ.md](./nanobot/2026-02-03/12-è®°å¿†ç³»ç»Ÿ.md)
